(()=>{var e={792:(e,t,r)=>{"use strict";r.d(t,{BZ:()=>n,G9:()=>g,Hv:()=>O,Ol:()=>b,QC:()=>l,U5:()=>h,WS:()=>y,X_:()=>a,bc:()=>o,cw:()=>m,gT:()=>v,mm:()=>u,oX:()=>s,zu:()=>w});var s,i=r(588);!function(e){e[e.all=1]="all",e[e.clazz=2]="clazz",e[e.property=3]="property",e[e.method=4]="method",e[e.parameter=5]="parameter"}(s||(s={}));const o=(e,t)=>({_type:0,_decorator:"@DecoratedClass",_provider:t,gid:e,clazz:void 0,metadata:[],methods:{},staticMethods:{},properties:{},staticProperties:{}}),n=e=>"function"==typeof e?.getBundleId,a=e=>n(e)?e.getBundleId():void 0;let c=[];const h=e=>t=>{t.getBundleId=()=>e;for(const r of c)r.bundleDeclared(e,t)},d={},l=e=>{e||(e=()=>!0);const t=[];for(const e of Object.keys(d))t.push(...d[e]);return t.filter(e)},f={},p={},u=e=>f[e]?{id:e,metadata:[...f[e]]}:{id:e,metadata:[]},g=e=>p[e]?[...p[e]]:[],v=e=>e.map((e=>u(e))),m=e=>v(e).map((e=>e.metadata)).reduce(((e,t)=>e.concat(t)),[]),y=(e,t)=>e.filter((e=>e.provider==t||e._provider==t)),b=(e,t)=>e.filter((e=>e.decorator==t||e._decorator==t)),w=(e,t)=>{};class O{constructor(e){this.curGid="",this.cur=o("",""),this.finalized=[],this.map={},this.changeTicks=0,this.provider=e,c.push(this)}getChangeTicks(){return this.changeTicks}checkProto(e){this.changeTicks++;const t=(0,i.zU)(e);this.curGid!=t&&(this.cur=o(t,this.provider),this.curGid=t,this.finalized.push(this.cur),this.map[t]=this.cur,((e,t)=>{d[e]||(d[e]=[]),d[e].push(t)})(t,this.cur))}getByGid(e){return this.map[e]}initProperty(e,t,r,i){const o=t?this.cur.staticProperties:this.cur.properties;o[e]||(o[e]=[]),o[e].push({...r,_type:s.property,_provider:this.provider,_decorator:i})}pushProperty(e,t,r,s=""){const i=!!e.prototype;this.checkProto(e),this.initProperty(t,i,r,s)}initMethod(e,t){const r=t?this.cur.staticMethods:this.cur.methods;r[e]||(r[e]={metadata:[],parameters:[]})}pushMethod(e,t,r,i=""){const o=!!e.prototype;this.checkProto(e),this.initMethod(t,o);const n={...r,_type:s.method,_provider:this.provider,_decorator:i};o?this.cur.staticMethods[t].metadata.push(n):this.cur.methods[t].metadata.push(n)}initParameter(e,t,r){this.initMethod(e,r);const s=r?this.cur.staticMethods:this.cur.methods;s[e].parameters[t]||(s[e].parameters[t]=[])}pushParameter(e,t,r,i,o=""){const n=!!e.prototype;this.checkProto(e),this.initParameter(t,r,n),(n?this.cur.staticMethods:this.cur.methods)[t].parameters[r].push({...i,_type:s.parameter,_provider:this.provider,_decorator:o})}pushClass(e,t,r=""){this.checkProto(e),this.cur.clazz=e,this.cur.metadata.push({...t,_type:s.clazz,_provider:this.provider,_decorator:r})}getFinalized(){return[...this.finalized]}bundleDeclared(e,t){this.cur.clazz===t&&((e,t)=>{f[e]||(f[e]=[],p[e]=[]),f[e].push(t),p[e].push(t.gid)})(e,this.cur)}}},588:(e,t,r)=>{"use strict";r.d(t,{JE:()=>f,zU:()=>l});const s={},i=[],o={};let n,a,c=1,h="",d=!1;const l=e=>{const t="function"==typeof e;let r=e;if(t&&(r=e.prototype),t){const t=h;if(d){if(a===e)return e.getDecoratorGid=()=>t,h}else if(n===r)return e.getDecoratorGid=()=>t,d=!0,a=e,o[h]=e,h}else if(!d&&r===n)return h;let l=(e=>{let t=e;"function"==typeof e&&(t=e.prototype);let r="",s="";for(let n=0;n<i.length;n++)i[n]===t&&(s=`${n+1}`),o[n]===e&&(r=`${n+1}`);return!r&&s?"":s||r})(e);return l||(l=""+c++,h=l,n=r,a=e,s[l]=r,i.push(r),o[h]=e,d=t,r.___gid=l,l)},f=e=>{const t=p(e);return t.___gid??t.getDecoratorGid()},p=e=>{if(t=e,"function"==typeof t?.getDecoratorGid||"string"==typeof t?.___gid)return e;var t;const r=l(e);return e.getDecoratorGid=()=>r,e.prototype?e.prototype.___gid=r:e.___gid=r,e}},214:(e,t,r)=>{"use strict";r.d(t,{Rj:()=>h,mA:()=>b});var s=r(209);const i=require("console");var o,n,a=r(792),c=function(e,t,r,s){var i,o=arguments.length,n=o<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,r):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,s);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(n=(o<3?i(n):o>3?i(t,r,n):i(t,r))||n);return o>3&&n&&Object.defineProperty(t,r,n),n};const h="logger",d=(0,a.U5)(h);var l;!function(e){e[e.TRACE=1]="TRACE",e[e.DEBUG=2]="DEBUG",e[e.INFO=3]="INFO",e[e.WARN=4]="WARN",e[e.ERROR=5]="ERROR"}(l||(l={}));const f={[l.TRACE]:"trace",[l.DEBUG]:"debug",[l.INFO]:"info",[l.WARN]:"warn",[l.ERROR]:"error"},p={[l.TRACE]:"TRACE",[l.DEBUG]:"DEBUG",[l.INFO]:"INFO ",[l.WARN]:"WARN ",[l.ERROR]:"ERROR "};class u{constructor(e,t){this.name=e,this.writer=t}debug(e,t,...r){this.writer.writeEvent({name:this.name,time:new Date,level:l.DEBUG},e,t,...r)}error(e,t,...r){this.writer.writeEvent({name:this.name,time:new Date,level:l.ERROR},e,t,...r)}info(e,t,...r){this.writer.writeEvent({name:this.name,time:new Date,level:l.INFO},e,t,...r)}trace(e,t,...r){this.writer.writeEvent({name:this.name,time:new Date,level:l.TRACE},e,t,...r)}warn(e,t,...r){this.writer.writeEvent({name:this.name,time:new Date,level:l.WARN},e,t,...r)}}const g="logger.writer";let v=o=class{createEvent({time:e,level:t,name:r},s,i,...n){const a=e.toISOString().substr(0,23);return`${a.substr(0,10)} ${a.substr(11,12)} [${p[t]}] [${r}] ${o.formatArgs(s,i,...n)}`}static formatArgs(e,t,...r){const s=[];let i=r;e instanceof Error?(s.push(`${e.message} ${JSON.stringify({stacktrace:e.stack})}`),void 0!==t&&(i=[t,...r])):t instanceof Error?(s.push(e),s.push(`${t.message} ${JSON.stringify({stacktrace:t.stack})}`)):"string"==typeof e?(s.push(e),void 0!==t&&(i=[t,...r])):i=[e,t,...r];for(const e of i)"object"==typeof e||e instanceof Array?s.push(JSON.stringify(e)):s.push(e);return s.join(" ")}};v=o=c([d,(0,s.t6)("logger.formatter.standard",{interfaces:["logger.formatter"]})],v);class m{constructor(e){this.writer=e}getMappedNames(){return this.writer.getMappedNames()}setWriter(e){this.writer=e}writeEvent(e,...t){const[r,s,...i]=t;this.writer.writeEvent(e,r,s,...i)}}let y=class{constructor(){this.level=l.INFO,this.formatter=new v}getMappedNames(){return["*"]}writeEvent(e,...t){const{level:r}=e;if(r<this.level)return;const s=f[r],[o,n,...a]=t;i[s](this.formatter.createEvent(e,o,n,...a))}};y=c([d,(0,s.t6)("logger.writer.console",{interfaces:[g]})],y);let b=n=class{constructor(){this.writers=[],this.prefixToWriters={"*":new y},this.loggers={}}static getSingleton(){return this.inst||(this.inst=new n),this.inst}setWriters(e){for(const t of e)for(const e of t.getMappedNames())this.prefixToWriters[e]||(this.prefixToWriters[e]=t,this.writers.push(t))}getLogger(e){if(this.loggers[e])return this.loggers[e];let t="*";for(const r of Object.keys(this.prefixToWriters))(e==r||e.startsWith(r))&&r.length>t.length&&(t=r);const r=new m(this.prefixToWriters[t]);return this.loggers[e]=new u(e,r),this.loggers[e]}has(e){return!0}resolve(e){return this.getLogger(e)}};b.inst=void 0,c([function(e,t){return function(r,s){t(r,s,e)}}(0,(0,s.tB)({matchInterface:g,matchCriteria:{min:0}}))],b.prototype,"setWriters",null),c([s.Fk],b,"getSingleton",null),b=n=c([d,(0,s.t6)("logger.loggerFactory",{isFactory:!0})],b)},209:(e,t,r)=>{"use strict";r.d(t,{Fk:()=>c,WD:()=>l,t6:()=>a,tB:()=>h});var s=r(31),i=r(588),o=r(637);const n=(0,o.fh)(),a=(e,t={})=>r=>{n.pushClass(r,{id:e,gid:(0,i.zU)(r),...t},"Service")},c=(e,t,r)=>{n.pushMethod(e,t,{type:s.Tr.factory,name:t},"Factory")},h=e=>(t,r,s)=>{n.pushParameter(t,r,s,{...e},"Inject")};let d;const l=()=>(d||(d=n.getFinalized()),d.map((e=>new o.CO(e))))},207:(e,t,r)=>{"use strict";r.d(t,{et:()=>o,hi:()=>f});var s=r(31),i=r(214);const o="service-container";class n{constructor(e){this.depServices={},this.depInterfaces={},this.resolve=e=>{},this.reject=e=>{},this.id=e,this.promise=new Promise(((e,t)=>{this.resolve=e,this.reject=t}))}isResolved(){return 0==Object.keys(this.depServices).length&&0==Object.keys(this.depInterfaces).length}}const a=i.mA.getSingleton(),c=a.getLogger("service-container"),h=a.getLogger("service-container.deptrack");class d{constructor(){this.waitingOnService={},this.waitingOnInterface={},this.interfaceCount={},this.serviceMap={},this.serviceTrackers={}}getTracker(e){return this.serviceTrackers[e]||(this.serviceTrackers[e]=new n(e)),this.serviceTrackers[e]}waitOnService(e,t){this.waitingOnService[e]||(this.waitingOnService[e]={}),this.waitingOnService[e][t]=1,this.getTracker(t).depServices[e]=!0,h.debug(`waitOnService: ${t} -> ${e}`)}waitOnInterface(e,t,r){0!==r.matchCriteria?.min&&(this.waitingOnInterface[e]||(this.waitingOnInterface[e]={}),this.waitingOnInterface[e][t]=r,this.getTracker(t).depInterfaces[e]=!0,h.debug(`waitOnInterface: ${t} -> ${e}`))}serviceAvailable(e){if(this.serviceMap[e]=1,!this.waitingOnService[e])return h.debug(`serviceAvailable: ${e} -> NO_WAITING_DEPS`),[];const t=Object.keys(this.waitingOnService[e]);h.debug(`serviceAvailable: ${e} ->`,t),delete this.waitingOnService[e];for(const r of t)delete this.serviceTrackers[r].depServices[e];return t}interfaceAvailable(e){if(!this.waitingOnInterface[e])return h.debug(`interfaceAvailable: ${e} -> NO_WAITING_DEPS`),[];this.interfaceCount[e]||(this.interfaceCount[e]=0),this.interfaceCount[e]++;const t=[];for(const r of Object.keys(this.waitingOnInterface[e])){const s=this.waitingOnInterface[e][r],i=s.matchCriteria?.min??1;console.log(`## ${e}: ${r} -> ${i}`),this.interfaceCount[e]>=i&&(delete this.waitingOnInterface[e][r],delete this.serviceTrackers[r].depInterfaces[e],t.push(r))}return h.debug(`serviceAvailable: ${e} ->`,t),t}bindToInterface(e,t,r){const s=void 0===r.matchCriteria?.min?1:r.matchCriteria.min;(this.interfaceCount[e]??0)<s?this.waitOnInterface(e,t,r):h.debug(`bindToInterface: ${t} -> ${e}`)}bindToService(e,t){if(this.serviceMap[e])h.debug(`bindToService: ${t} -> ${e}`);else{const[r,s]=e.split("@");this.waitOnService(s??e,t)}}}class l{constructor(e){this.container=e}has(e){console.log("?> ",e);const[t,r]=e.split("@");return this.assertIsFactory(r),!!this.container.has(r)&&this.container.resolve(r).has(t)}resolve(e){console.log("?? ",e);const[t,r]=e.split("@");this.assertIsFactory(r);const s=this.container.resolve(r).resolve(t);if(!s)throw new Error(`${e}: service not found`);return s}assertIsFactory(e){if(!this.container.isFactory(e))throw new Error(`${e}: not a factory`)}}class f{constructor(e=[]){this.records={},this.instances={},this.recordsById={},this.recordsByGid={},this.interfaceToRec={},this.started=!1,this.depTracker=new d,this.interfaceSubscribers={},e.forEach((e=>this.register(e))),this.factoryHelper=new l(this),this.logger=c}has(e){return!!e&&(e.includes("@")?this.factoryHelper.has(e):void 0!==this.instances[e])}hasGid(e){return this.has(this.records[this.recordsByGid[e]]?.id)}resolve(e){if(e.includes("@"))return this.factoryHelper.resolve(e);if(!this.has(e))throw new Error(`${e}: service not found`);return this.instances[e]}resolveGid(e){const t=this.recordsByGid[e];return this.resolve(t)}query(e){if(!this.interfaceToRec[e])return[];const t=[];return this.interfaceToRec[e].forEach((e=>{const r=this.records[e],s=r.id;this.has(s)&&t.push([r.priority,this.resolve(s)])})),t.sort((([e],[t])=>e<t?1:e>t?-1:0)).map((([e,t])=>t))}register(e){return this.recordsById[e.id]||(this.records[e.id]=e,this.recordsByGid[e.gid]=e.id,e.interfaces.forEach((t=>{this.interfaceToRec[t]||(this.interfaceToRec[t]=[]),this.interfaceToRec[t].push(e.id)})),this.started),this}async startup(){if(this.started)return this;const e=Object.values(this.records).sort((({priority:e},{priority:t})=>e<t?1:e>t?-1:0)),t=[];for(const i of e)!i.isDisabled&&((r=i.status)<s.R0.activating||r>s.R0.deactivating)&&t.push(this.initServiceFromRecord(i).then((e=>{i.status=s.R0.activated,this.logger.info(`! startup: ${i.id} AVAILABLE`);const t=this.depTracker.serviceAvailable(i.id),r=[],o=i.interfaces.map((e=>(r.push(e),this.depTracker.interfaceAvailable(e)))).reduce(((e,t)=>e.concat(t)),[]);this.registerInterfaceSubscriptions(i.id,e,i.subscribeToInterfaces),this.wakeUpDependents(t.concat(o)),console.log("🥁 ",i.id,i.interfaces),this.notifyInterfacesAvailable(e,o)})).catch((e=>{this.logger.error(e)})));var r;return this.started=!0,await Promise.all(t).catch((e=>{this.logger.error("startup failed",e)})),this}async initServiceFromRecord(e){const t=this.depTracker.getTracker(e.id);return this.waitOnDependencies(e,t).then((async t=>{const r=this.makeInstance(e);return this.instances[e.id]=r,this.processInjections(e,r),this.activateService(e,r).then((()=>r))}))}async waitOnDependencies(e,t){const r=Object.keys(e.dependencies);this.logger.info(`waitOnDependencies: ${e.id} ->`,r.length>1?r:"NO_DEPS");for(const t of r)if(t.startsWith("#")){const r=t.substring(1),s=e.dependencies[t];this.depTracker.bindToInterface(r,e.id,{matchCriteria:s})}else{const[r,s]=t.split("@");this.depTracker.bindToService(s||t,e.id)}const s=this.depTracker.getTracker(e.id);return s.isResolved()&&s.resolve(e.id),s.promise}registerInterfaceSubscriptions(e,t,r){for(const s of r)this.interfaceSubscribers[s]||(this.interfaceSubscribers[s]={}),this.interfaceSubscribers[s][e]=t}wakeUpDependents(e){const t={};for(const r of e){if(t[r])continue;t[r]=!0;const e=this.depTracker.getTracker(r);e.isResolved()&&(this.logger.info(`. wakeUpDependents: ${r} RESOLVED`),e.resolve(r))}}notifyInterfacesAvailable(e,t){for(const r of t)if(this.interfaceSubscribers[r])for(const t in this.interfaceSubscribers[r]){console.log("<<<",t,r);try{this.interfaceSubscribers[r][t].onAvailableInterface(r,[e])}catch(e){this.logger.error(`notifyInterfacesAvailable: ${r} -> ${t}`,e)}}}async shutdown(){if(!this.started)throw new Error("serviceContainer not started");const e=[];for(const t of Object.values(this.records))t.isDisabled||t.status==s.R0.activated||e.push(this.deactivateService(t,this.instances[t.id]).catch((e=>{this.logger.error(`failed to successfully deactivate: ${t.id}`,e)})).finally((()=>{delete this.instances[t.id],t.status=s.R0.deactivated})));return this.started=!1,this}makeInstance(e){const t=e.clazz,r=e.injectConfig?this.resolve(e.injectConfig):void 0;return e.factory?r?t[e.factory](r,...this.getDependenciesAsArgs(e.injectableFactory)):t[e.factory](...this.getDependenciesAsArgs(e.injectableFactory)):r?new t(r):new t}processInjections(e,t){for(const r of Object.keys(e.injectableMethods))t[r](...this.getDependenciesAsArgs(e.injectableMethods[r]))}getDependenciesAsArgs(e){return e.map((e=>{if(e){if(e.id)return this.resolve(e.id);if(e.matchInterface)return this.query(e.matchInterface)}}))}async activateService(e,t){if(e.activator)return Promise.resolve(t[e.activator]())}async deactivateService(e,t){if(e.deactivator)return Promise.resolve(t[e.deactivator]())}isFactory(e){return!!this.records[e].isFactory}static analyzeDependencies(e){const t=new d,r={};let s=Object.values(e).map(((e,t)=>(e.id&&(r[e.id]=t),e.id))).filter((e=>void 0!==e));for(;s.length>0;){const i=s.shift(),o=e[r[i]];if(t.getTracker(i),o.isDisabled)continue;let n=0;for(const e of Object.keys(o.dependencies)){const r=o.dependencies[e];if(0===r?.min)continue;let[s,i]=e.split("@"),a=i||e;t.serviceMap[a]||(t.waitOnService(a,o.id),n++)}if(0==n){let e=t.serviceAvailable(o.id);for(const r of o.interfaces)e=e.concat(t.interfaceAvailable(r));const r={};for(const i of e)r[i]||(r[i]=!0,t.getTracker(i).isResolved()&&s.push(i))}}const i=[];for(const s of Object.keys(t.serviceTrackers)){const o=t.serviceTrackers[s],n={id:s,status:e[r[s]].isDisabled?"DISABLED":o.isResolved()?"RESOLVED":"UNRESOLVED",unresolvedDeps:Object.keys(o.depServices).concat(Object.keys(o.depInterfaces).map((e=>`#${e}`)))};i.push(n)}return i}}},31:(e,t,r)=>{"use strict";var s,i,o;r.d(t,{R0:()=>i,Tr:()=>o,gA:()=>s}),function(e){e[e.bootstrap=1e4]="bootstrap",e[e.datalink=9e4]="datalink",e[e.config=8e4]="config",e[e.usercritical=1e4]="usercritical",e[e.default=0]="default",e[e.userlow=-1e4]="userlow"}(s||(s={})),function(e){e[e.registered=0]="registered",e[e.activating=11]="activating",e[e.activated=20]="activated",e[e.deactivating=21]="deactivating",e[e.deactivated=30]="deactivated"}(i||(i={})),function(e){e[e.activate=1]="activate",e[e.deactivate=2]="deactivate",e[e.factory=3]="factory",e[e.injectable=4]="injectable"}(o||(o={}))},637:(e,t,r)=>{"use strict";r.d(t,{CO:()=>h,H_:()=>f,GV:()=>d,fh:()=>p,PJ:()=>u});var s=r(31),i=r(792),o=r(209);const n=require("lodash.clonedeep");var a=r.n(n),c=r(588);class h{constructor(e){this.provider="",this.id="",this.gid="",this.priority=0,this.injectConfig="",this.interfaces=[],this.status=s.R0.registered,this.factory="",this.injectableFactory=[],this.activator="",this.deactivator="",this.dependencies={},this.injectableMethods={},this.subscribeToInterfaces=[],this.originalMeta=e,this.initFromDecoratedClass(e)}initFromDecoratedClass(e){if(1!=e.metadata.length)throw new Error(`expected exactly 1 decoration, got: ${e.metadata.length}`);this.provider=e._provider,this.id=e.metadata[0].id,this.gid=e.metadata[0].gid,this.isDisabled=e.metadata[0].disabled,this.isFactory=e.metadata[0].isFactory,this.config=e.metadata[0].config;const t=e.metadata[0].injectConfig;t&&(this.injectConfig=!0===t?u(this.id):t,this.dependencies[this.injectConfig]={}),this.clazz=e.clazz,this.priority=e.metadata[0].priority??0,this.interfaces=e.metadata[0].interfaces??[],this.subscribeToInterfaces=e.metadata[0].subscribeToInterfaces??[],this.processMethods(e.methods),this.processMethods(e.staticMethods,!0)}processMethods(e,t=!1){for(const t of Object.keys(e)){const r=e[t],i=r.parameters.map((e=>{if(e)return e[0].id&&(this.dependencies[e[0].id]={}),e[0].matchInterface&&(this.dependencies["#"+e[0].matchInterface]=e[0].matchCriteria??{min:1}),e[0]}));switch(r.metadata[0]?.type){case s.Tr.activate:this.activator=t;break;case s.Tr.deactivate:this.deactivator=t;break;case s.Tr.factory:this.factory=t,this.injectableFactory=i;break;default:this.injectableMethods[t]=i}}}clone(e){return new h(this.createNewClassServiceMeta(e))}cloneAndRegisterNewService(e,t){const r=class extends this.clazz{},s=(0,c.zU)(r);r.getDecoratorGid=()=>s;const i=this.createNewClassServiceMeta(t);return i.clazz=r,i.gid=s,i.metadata[0].id=e,i.metadata[0].gid=s,new h(i)}createNewClassServiceMeta(e){const t=a()(this.originalMeta),r=t.metadata[0],{priority:s,config:i,injectConfig:o,isFactory:n,interfaces:c,disabled:h}=e;return r.disabled=void 0===h?this.isDisabled:h,void 0!==s&&(r.priority=s),i&&(r.config=i),o&&(r.injectConfig=o),n&&(r.isFactory=n),c&&(r.interfaces=[...c]),t}}const d=()=>{const e={};for(const t of(0,o.WD)())e[t.id]||(e[t.id]=[]),e[t.id].push(t);return e};let l;const f=e=>{l||(l=(()=>{const e={};for(const t of(0,o.WD)())e[t.gid]=t;return e})());const t=(0,i.G9)(e),r=[];for(const e of t)l[e]&&r.push(l[e]);return r},p=()=>new i.Hv("service-container"),u=e=>`${e}@runtime.configProvider`},370:e=>{function t(e){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}t.keys=()=>[],t.resolve=t,t.id=370,e.exports=t}},t={};function r(s){var i=t[s];if(void 0!==i)return i.exports;var o=t[s]={exports:{}};return e[s](o,o.exports,r),o.exports}r.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return r.d(t,{a:t}),t},r.d=(e,t)=>{for(var s in t)r.o(t,s)&&!r.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var s={};(()=>{"use strict";r.r(s),r.d(s,{BasicMorpherManager:()=>d,BundleDecoratorFactory:()=>e.U5,DecoratedClassBuilder:()=>e.Hv,Dinoframe:()=>W,ExpressApp:()=>y,HttpBundle:()=>m,HttpServer:()=>b,MorphMarshaller:()=>c,NAME_CATCH_ALL:()=>a,PROVIDER_ID:()=>v,RecordType:()=>e.oX,ValueFactory:()=>h,duplicateDecoratorsForGid:()=>e.zu,filterByDecorator:()=>e.Ol,filterMetadataByProvider:()=>e.WS,flattenManyBundlesMetadata:()=>e.cw,getBundleId:()=>e.X_,getBundledMetadata:()=>e.mm,getEmptyDecoratedClass:()=>e.bc,getGidsForBundle:()=>e.G9,getGlobalDecoratedClasses:()=>e.QC,getManyBundlesMetadata:()=>e.gT,hasBundleId:()=>e.BZ});var e=r(792);class t extends Error{constructor(e){super(e)}}class i extends t{constructor(e){super(e)}}class o extends t{constructor(e,t){super(`One or more errors for: ${e}`),this.fieldErrors=t}}var n=r(588);const a="*";class c{constructor(e,t){this.propertyDefs={},this.discriminatorCol="",this.subclasses={},this.ignoreProps=[],this.manager=t,this.originalMeta=e,this.clazz=e.clazz;const r=e.metadata[0];this.ignoreProps=r.ignoreProps??[],r.inherits?.baseClass&&!r.inherits.discriminatorValue&&(this.baseClass=r.inherits.baseClass),this.clazz.___discriminatorMap&&(this.discriminatorCol=this.clazz.___discriminatorCol,this.subclasses={...this.clazz.___discriminatorMap}),this.init()}getGid(){return this.originalMeta.gid}init(){this.initProperties(),this.initMethods()}canHandle(e){return this.clazz===e}initProperties(){for(const e in this.originalMeta.properties){const{name:t,...r}=this.originalMeta.properties[e][0];this.updateProperty(t,r)}}initMethods(){for(const e of Object.values(this.originalMeta.methods)){const t=e.metadata[0];t.finalize?this.finalizeMethod=t.finalize:t.serialize?this.serializeMethod=t.serialize:t.deserialize?this.deserializeMethod=t.deserialize:this.updateProperty(t.name,t)}}updateProperty(e,t){this.propertyDefs[e]||(this.propertyDefs[e]={name:e}),this.propertyDefs[e]={...this.propertyDefs[e],...t}}makeInstance(e){if(!this.discriminatorCol)return[new this.clazz,null];try{const t=e[this.discriminatorCol],r=this.subclasses[t];return[new r,r]}catch(r){throw new t(`${this.clazz.name}: could not map ${this.clazz.___discriminatorCol}=${e[this.clazz.___discriminatorCol]} to a subclass: ${r.message}`)}}doSetValue(e,t,r,s){const i=r.name;if(null!=t){if("function"==typeof r.type)t=t instanceof Array?t.map((e=>this.deserializeNested(e,r.type))):this.deserializeNested(t,r.type);else try{h.validateValue(t,r)}catch(e){s[i]=e}if(r.setter)try{e[r.setter](t)}catch(e){return void(s[i]={message:e.message,exception:e})}else if(r.propertyName){if(r.validator){const e=r.validator(t,i);if(e)return void(s[i]=e)}else if(r.required&&(""===t||null===t))return void(s[i]={message:"required"});e[r.propertyName]=t}}else r.required&&(s[i]={message:"required"})}doDeserialize(e,t,r){const s={};let i=null;const n={};for(const o in this.propertyDefs){const c={...this.propertyDefs[o],...r[o]??{}};if(o==a){i=c;continue}let h=t[o];n[o]=o,this.doSetValue(e,h,c,s)}if(i){let r={};for(const e in t)n[e]||(r[e]=t[e]);this.doSetValue(e,r,i,s)}if(Object.keys(s).length>0)throw new o(this.clazz.name,s);return this.finalizeMethod&&e[this.finalizeMethod](),e}getAncestorStack(){const e=[this];let t=this.manager.getByClassOrId(this.baseClass);for(;t;)e.unshift(t),t=this.manager.getByClassOrId(t.baseClass);return e}deserializeAncestors(e,t,r){const s=this.getAncestorStack();for(const i of s)i.doDeserialize(e,t,r)}deserialize(e,t){const[r,s]=this.makeInstance(e);let i=t??{};if(this.deserializeMethod)return r[this.deserializeMethod](e,this.manager),r;if(this.baseClass?this.deserializeAncestors(r,e,i):this.doDeserialize(r,e,i),s){const t=this.manager.getByClassOrId(s);t?.doDeserialize(r,e,i)}return r}doSerialize(e,t,r){let s=null;for(const i in this.propertyDefs){if(i==a){s=this.propertyDefs[i];continue}const o={...this.propertyDefs[i],...r[i]??{}};let n;o.getter?n=t[o.getter]():o.propertyName&&(n=t[o.propertyName]),"function"==typeof o.type&&(n=n instanceof Array?n.map((e=>this.serializeNested(e,o.type))):this.serializeNested(n,o.type)),e[i]=n}if(s){let r={};s.getter?r=t[s.getter]:s.propertyName&&(r=t[s.propertyName]);for(const t in r)e[t]=r[t]}for(const t of this.ignoreProps)delete e[t]}serializeAncestors(e,t,r){const s=this.getAncestorStack();for(const i of s)i.doSerialize(e,t,r)}serialize(e,t){const r={};let s=t??{};if(this.serializeMethod)return e[this.serializeMethod](this.manager);if(this.baseClass?this.serializeAncestors(r,e,s):this.doSerialize(r,e,s),this.discriminatorCol){const t=this.subclasses[r[this.discriminatorCol]];if(t){const s=this.serializeNested(e,t);for(const e in s){const t=s[e];void 0!==t&&(r[e]=t)}}}return r}deserializeNested(e,t){const r=this.manager.getByClassOrId(t);return r?r.deserialize(e):e}serializeNested(e,t){const r=this.manager.getByClassOrId(t);return r?r.serialize(e):null}update(e,t,r){this.doDeserialize(e,{...e,source:t},r??{})}}class h{static validateValue(e,t){if("strict"==t.listType&&!(e instanceof Array))throw new i(`listType=strict, ${typeof e} given`);if(e instanceof Array){if(!t.listType)throw new i("listType=none, array given");let r={},s=0;for(let i=0;i<e.length;i++)try{this.assertProperType(e[i],t)}catch(e){r[i]=e.message,s++}if(s)throw new i(`one or more errors: ${JSON.stringify(r)}`)}else this.assertProperType(e,t)}static assertProperType(e,t){switch(t.type){case"boolean":if("boolean"!=typeof e)throw new i(`not a boolean: ${JSON.stringify(e)}`);break;case"string":if("string"!=typeof e)throw new i(`not a string: ${JSON.stringify(e)}`);break;case"number":if("number"!=typeof e)throw new i(`not a number: ${JSON.stringify(e)}`);break;case"enum":if(!t.enumValues?.includes(e))throw new i(`${e} does not match any enum values: [${t.enumValues?.join("; ")}]`)}}}class d{constructor(e=[]){this.morphers={};for(const t of e)this.morphers[t.gid]=new c(t,this)}getByClassOrId(e){if(!e)return;const t="string"==typeof e?e:(0,n.JE)(e);return this.morphers[t]}deserializeTo(e,r){const s=this.getByClassOrId(r);if(!s)throw new t(`deserialize: no morpher for ${r.name}`);return s.deserialize(e)}serializeFrom(e){const r=this.getByClassOrId(Object.getPrototypeOf(e));if(!r)throw new t(`serialize: no morpher for ${e}`);return r.serialize(e)}}var l=r(209);const f=require("express");var p=r.n(f);const u=require("http");var g=function(e,t,r,s){var i,o=arguments.length,n=o<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,r):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,s);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(n=(o<3?i(n):o>3?i(t,r,n):i(t,r))||n);return o>3&&n&&Object.defineProperty(t,r,n),n};const v="dinoframe.http",m=(0,e.U5)(v);let y=class{static getInstance(){return p()()}static discover(){return v}};g([l.Fk],y,"getInstance",null),y=g([m,(0,l.t6)("express.app")],y);let b=class{static getInstance(e){return u.createServer(e)}};g([l.Fk,function(e,t){return function(r,s){t(r,s,e)}}(0,(0,l.tB)({id:"express.app"}))],b,"getInstance",null),b=g([m,(0,l.t6)("http.server")],b);var w,O,z=r(207);(O=w||(w={}))[O.route=1]="route",O[O.middleware=2]="middleware",O[O.error=3]="error";class C extends Error{constructor(e,t){super(e),this.params=t}}const I=new e.Hv("dinoframe.http"),S=(e,t,r)=>{const s=[];for(let i=0;i<r.parameters.length;i++){if(void 0===r.parameters[i]){s[i]=void 0;continue}let o;const n=r.parameters[i][0],{name:a,transformer:c}=n;o=e.query[a],c&&(o=c(o,{request:e,response:t,def:n})),s[i]=o}const i=r.metadata[0].type===w.error?4:3;return s.slice(i)},D=(e,t,r,s)=>(i,o,n)=>{try{s?.(i,o);const a=S(i,o,r);return((e,t,r,s)=>{for(const o of s.parameters){if(!o)continue;const s=o[0],{name:n,required:a,enumValues:c,validator:h,transformer:d}=s;for(const o of e){if(a&&(""===(i=o)||null==i))throw new C(`${n}: required`,s);if(h){const e=h(o,{request:t,response:r,def:s});if(e)throw new C(`${n}: ${e}`,s)}if(c&&!c.includes(o))throw new C(`${n}: got ${o}; expected: ${JSON.stringify(c)}`,s)}}var i})(a,i,o,r),e[t](i,o,n,...a)}catch(e){n(e)}},_=(e,t,r)=>(s,i,o,n)=>{const a=S(i,o,r);return e[t](s,i,o,n,...a)};class ${constructor(e,t=[]){this.container=e,this.controllers=[...t]}setControllers(e){return this.controllers=[...e],this}bind(e){const t=[];for(const e of this.controllers){const{gid:r,clazz:s}=e,i=this.container.hasGid(r)?this.container.resolveGid(r):new s;let{path:o,methods:n,headers:a}=e.metadata[0];o||(o=""),n||(n=["GET"]),a||(a={});for(const r of Object.keys(e.methods)){const s=e.methods[r];for(const c of s.metadata){let{type:h,path:d,methods:l,headers:f,priority:p}=c;l=l??n,f||(f={...a}),d=h===w.error?void 0:void 0!==d?`${o}${d}`:void 0,p=p??0;const u=h===w.error?_(i,r,s):D(i,r,s);t.push([u,{...c,path:d,headers:f,methods:l,priority:p},e])}}}t.sort((([e,t],[r,s])=>{const i=t.priority,o=s.priority;return i<o?1:i>o?-1:0})).forEach((([t,r,s])=>e(t,r,s)))}}var k=r(637);class T{constructor(e,t){this.id=e,this.config=t}loadDependencies(){const e=this.config.bundleDependencies??[],t=this.config.moduleDependencies??[];for(let s of t){const[t,i]=s.split(":");let o=r(370)(t);i&&(o=o[i]),e.push(o.discover())}return e}processServiceRecords(e,t){const r={};for(const e of this.config.services){const t=e.runtimeId??e.id;r[t]||(r[t]=e)}const s={};for(const t of e){s[t.id]=t;const e=r[t.id];if(e){const r=e.meta??{};let i,o=e.config;o&&(i=(0,k.PJ)(t.id),o={...t.originalMeta.metadata[0].config??{},...o}),r.injectConfig=i,s[t.id]=t.clone({id:t.id,gid:t.gid,...r,config:e.config,disabled:e.disabled})}}for(const e of Object.keys(r)){if(s[e])continue;const t=r[e];if(t){const r=t.meta??{};let i,o=t.config;o&&(i=(0,k.PJ)(e),o={...s[t.id].originalMeta.metadata[0].config??{},...o}),r.injectConfig=i,s[e]=s[t.id].cloneAndRegisterNewService(e,{id:e,gid:"",...r,config:o,disabled:t.disabled})}}return Object.values(s)}}var E,R=r(31),A=function(e,t,r,s){var i,o=arguments.length,n=o<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,r):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,s);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(n=(o<3?i(n):o>3?i(t,r,n):i(t,r))||n);return o>3&&n&&Object.defineProperty(t,r,n),n};const j="runtime",M=(0,e.U5)(j);class P{constructor(e){this.config={},this.config={...e}}get(e){return this.config[e]}getWithPrefix(e){const t={};for(const r of Object.keys(this.config))r.startsWith(e)&&(t[r]=this.config[r]);return t}getAll(){return{...this.config}}}console.log(l.t6);let N=class{static makeRuntimeEnv(){return new P(process.env)}};A([l.Fk],N,"makeRuntimeEnv",null),N=A([M,(0,l.t6)(`${j}.environment`,{interfaces:["runtime.env"],priority:R.gA.bootstrap})],N);const B="configProvider",F=`${B}.configInstance`;let G=E=class{constructor(){this.configs={}}static getSingleton(){return this.singleton}has(e){return void 0!==this.configs[e]}resolve(e){if(!this.configs[e])throw new Error(`could not find config: ${e}`);return this.configs[e]}addConfig(e,t){this.configs[e]=t}onAvailableInterface(e,t){for(const e of t)e.getId&&e.getAll&&this.addConfig(e.getId(),e)}setConfigs(e){this.onAvailableInterface("",e)}};G.singleton=new E,A([function(e,t){return function(r,s){t(r,s,e)}}(0,(0,l.tB)({matchInterface:F,matchCriteria:{min:0}}))],G.prototype,"setConfigs",null),A([l.Fk],G,"getSingleton",null),G=E=A([M,(0,l.t6)(`${j}.${B}`,{isFactory:!0,priority:R.gA.bootstrap,subscribeToInterfaces:[F]})],G);var x=r(214);class W{constructor(e){this.bundleConfigs={},this.bundleIds=[j,x.Rj].concat(e),this._serviceContainer=new z.hi,this._httpBinder=new $(this._serviceContainer)}get serviceContainer(){return this._serviceContainer}get httpBinder(){return this._httpBinder}addBundleConfig(e,t){return this.bundleConfigs[e]=t,this}getExpressApp(){return this._serviceContainer.resolve(W.ID_EXPRESS_APP)}getHttpServer(){return this._serviceContainer.resolve(W.ID_HTTP_SERVER)}activateBundles(){const e={};let t=[];for(const r of this.bundleIds){if(e[r])continue;const s=(0,k.H_)(r);if(this.bundleConfigs[r]){const e=new T(r,this.bundleConfigs[r]),i=e.loadDependencies();for(const e of i)this.bundleIds.push(e);t=t.concat(e.processServiceRecords(s,(0,k.GV)()))}else t=t.concat(s)}return t}async startup(){const t=this.activateBundles(),s=(0,e.WS)(t,r(207).et),i=G.getSingleton();s.forEach((e=>{e.config&&i.addConfig(e.id,new P(e.config)),this._serviceContainer.register(e)}));try{await this._serviceContainer.startup()}catch(e){throw console.error(e),e}const o=(n=t.map((e=>e.gid)),I.getFinalized().filter((e=>n.includes(e.gid))));var n;this.processHttpDecorators(o)}processHttpDecorators(e){if(!this._serviceContainer.has(W.ID_EXPRESS_APP))return void console.warn(`processHttpDecorators(): ${W.ID_EXPRESS_APP} not found, skipping http`);const t=this.getExpressApp();this._httpBinder.setControllers(e).bind(((e,r,s)=>{const{path:i,methods:o,type:n}=r,a=o?o.map((e=>e.toLowerCase())):["get"],c=`gid=${s.gid} ${s.clazz.name}`;switch(n){case w.route:let s=i;"*"==a[0]?(console.log(`express.app.route: (${r.priority} - ${c}.${r.name}) ${a[0]} ${i}`),t.all(s,e)):a.forEach((o=>{console.log(`express.app.route: (${r.priority} - ${c}.${r.name}) ${o} ${i}`),t[o](s,e)}));break;case w.middleware:i?(console.log(`express.app.middleware: (${r.priority} - ${c}.${r.name}) ${i}`),t.use(i,e)):(console.log(`express.app.middleware: (${r.priority} - ${c}.${r.name})`),t.use(e));break;case w.error:console.log(`express.app.errorhandler: (${r.priority} - ${c}.${r.name})`),t.use(e)}}))}}W.ID_EXPRESS_APP="express.app",W.ID_HTTP_SERVER="http.server"})(),module.exports=s})();